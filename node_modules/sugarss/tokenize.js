'use strict';

exports.__esModule = true;
exports.default = tokenize;
var SINGLE_QUOTE = 39;
var DOUBLE_QUOTE = 34;
var BACKSLASH = 92;
var SLASH = 47;
var NEWLINE = 10;
var SPACE = 32;
var FEED = 12;
var TAB = 9;
var CR = 13;
var OPEN_PARENTHESES = 40;
var CLOSE_PARENTHESES = 41;
var OPEN_CURLY = 123;
var CLOSE_CURLY = 125;
var SEMICOLON = 59;
var ASTERICK = 42;
var COLON = 58;
var AT = 64;
var COMMA = 44;

var RE_AT_END = /[ \n\t\r\f\{\(\)'"\\;/]/g;
var RE_NEW_LINE = /[\r\f\n]/g;
var RE_WORD_END = /[ \n\t\r\f\(\)\{\}:;@!'"\\,]|\/(?=\*)/g;
var RE_BAD_BRACKET = /.[\\\/\("'\n]/;

function tokenize(input) {
    var tokens = [];
    var css = input.css.valueOf();

    var code = void 0,
        next = void 0,
        quote = void 0,
        lines = void 0,
        last = void 0,
        content = void 0,
        escape = void 0,
        nextLine = void 0,
        nextOffset = void 0,
        escaped = void 0,
        escapePos = void 0,
        prev = void 0,
        n = void 0;

    var length = css.length;
    var offset = -1;
    var line = 1;
    var pos = 0;

    function unclosed(what) {
        throw input.error('Unclosed ' + what, line, pos - offset);
    }

    while (pos < length) {
        code = css.charCodeAt(pos);

        if (code === NEWLINE || code === FEED || code === CR && css.charCodeAt(pos + 1) !== NEWLINE) {
            offset = pos;
            line += 1;
        }

        switch (code) {
            case CR:
                if (css.charCodeAt(pos + 1) === NEWLINE) {
                    offset = pos;
                    line += 1;
                    pos += 1;
                    tokens.push(['newline', '\r\n', line - 1]);
                } else {
                    tokens.push(['newline', '\r', line - 1]);
                }
                break;

            case FEED:
            case NEWLINE:
                tokens.push(['newline', css.slice(pos, pos + 1), line - 1]);
                break;

            case SPACE:
            case TAB:
                next = pos;
                do {
                    next += 1;
                    code = css.charCodeAt(next);
                } while (code === SPACE || code === TAB);

                tokens.push(['space', css.slice(pos, next)]);
                pos = next - 1;
                break;

            case OPEN_CURLY:
                tokens.push(['{', '{', line, pos - offset]);
                break;

            case CLOSE_CURLY:
                tokens.push(['}', '}', line, pos - offset]);
                break;

            case COLON:
                tokens.push([':', ':', line, pos - offset]);
                break;

            case SEMICOLON:
                tokens.push([';', ';', line, pos - offset]);
                break;

            case COMMA:
                tokens.push([',', ',', line, pos - offset]);
                break;

            case OPEN_PARENTHESES:
                prev = tokens.length ? tokens[tokens.length - 1][1] : '';
                n = css.charCodeAt(pos + 1);
                if (prev === 'url' && n !== SINGLE_QUOTE && n !== DOUBLE_QUOTE && n !== SPACE && n !== NEWLINE && n !== TAB && n !== FEED && n !== CR) {
                    next = pos;
                    do {
                        escaped = false;
                        next = css.indexOf(')', next + 1);
                        if (next === -1) unclosed('bracket');
                        escapePos = next;
                        while (css.charCodeAt(escapePos - 1) === BACKSLASH) {
                            escapePos -= 1;
                            escaped = !escaped;
                        }
                    } while (escaped);

                    tokens.push(['brackets', css.slice(pos, next + 1), line, pos - offset, line, next - offset]);
                    pos = next;
                } else {
                    next = css.indexOf(')', pos + 1);
                    content = css.slice(pos, next + 1);

                    if (next === -1 || RE_BAD_BRACKET.test(content)) {
                        tokens.push(['(', '(', line, pos - offset]);
                    } else {
                        tokens.push(['brackets', content, line, pos - offset, line, next - offset]);
                        pos = next;
                    }
                }

                break;

            case CLOSE_PARENTHESES:
                tokens.push([')', ')', line, pos - offset]);
                break;

            case SINGLE_QUOTE:
            case DOUBLE_QUOTE:
                quote = code === SINGLE_QUOTE ? '\'' : '"';
                next = pos;
                do {
                    escaped = false;
                    next = css.indexOf(quote, next + 1);
                    if (next === -1) unclosed('quote');
                    escapePos = next;
                    while (css.charCodeAt(escapePos - 1) === BACKSLASH) {
                        escapePos -= 1;
                        escaped = !escaped;
                    }
                } while (escaped);

                content = css.slice(pos, next + 1);
                lines = content.split('\n');
                last = lines.length - 1;

                if (last > 0) {
                    nextLine = line + last;
                    nextOffset = next - lines[last].length;
                } else {
                    nextLine = line;
                    nextOffset = offset;
                }

                tokens.push(['string', css.slice(pos, next + 1), line, pos - offset, nextLine, next - nextOffset]);

                offset = nextOffset;
                line = nextLine;
                pos = next;
                break;

            case AT:
                RE_AT_END.lastIndex = pos + 1;
                RE_AT_END.test(css);
                if (RE_AT_END.lastIndex === 0) {
                    next = css.length - 1;
                } else {
                    next = RE_AT_END.lastIndex - 2;
                }
                tokens.push(['at-word', css.slice(pos, next + 1), line, pos - offset, line, next - offset]);
                pos = next;
                break;

            case BACKSLASH:
                next = pos;
                escape = true;

                nextLine = line;

                while (css.charCodeAt(next + 1) === BACKSLASH) {
                    next += 1;
                    escape = !escape;
                }
                code = css.charCodeAt(next + 1);
                if (escape) {
                    if (code === CR && css.charCodeAt(next + 2) === NEWLINE) {
                        next += 2;
                        nextLine += 1;
                        nextOffset = next;
                    } else if (code === CR || code === NEWLINE || code === FEED) {
                        next += 1;
                        nextLine += 1;
                        nextOffset = next;
                    } else {
                        next += 1;
                    }
                }
                tokens.push(['word', css.slice(pos, next + 1), line, pos - offset, line, next - offset]);
                if (nextLine !== line) {
                    line = nextLine;
                    offset = nextOffset;
                }
                pos = next;
                break;

            default:
                n = css.charCodeAt(pos + 1);

                if (code === SLASH && n === ASTERICK) {
                    next = css.indexOf('*/', pos + 2) + 1;
                    if (next === 0) unclosed('comment');

                    content = css.slice(pos, next + 1);
                    lines = content.split('\n');
                    last = lines.length - 1;

                    if (last > 0) {
                        nextLine = line + last;
                        nextOffset = next - lines[last].length;
                    } else {
                        nextLine = line;
                        nextOffset = offset;
                    }

                    tokens.push(['comment', content, line, pos - offset, nextLine, next - nextOffset]);

                    offset = nextOffset;
                    line = nextLine;
                    pos = next;
                } else if (code === SLASH && n === SLASH) {
                    RE_NEW_LINE.lastIndex = pos + 1;
                    RE_NEW_LINE.test(css);
                    if (RE_NEW_LINE.lastIndex === 0) {
                        next = css.length - 1;
                    } else {
                        next = RE_NEW_LINE.lastIndex - 2;
                    }

                    content = css.slice(pos, next + 1);

                    tokens.push(['comment', content, line, pos - offset, line, next - offset, 'inline']);

                    pos = next;
                } else {
                    RE_WORD_END.lastIndex = pos + 1;
                    RE_WORD_END.test(css);
                    if (RE_WORD_END.lastIndex === 0) {
                        next = css.length - 1;
                    } else {
                        next = RE_WORD_END.lastIndex - 2;
                    }

                    tokens.push(['word', css.slice(pos, next + 1), line, pos - offset, line, next - offset]);
                    pos = next;
                }

                break;
        }

        pos++;
    }

    return tokens;
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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R0FBakIsRUFGRztBQUdILHdCQUFLLFlBQVksU0FBWixLQUEwQixDQUExQixFQUE4QjtBQUMvQiwrQkFBTyxJQUFJLE1BQUosR0FBYSxDQUFiLENBRHdCO3FCQUFuQyxNQUVPO0FBQ0gsK0JBQU8sWUFBWSxTQUFaLEdBQXdCLENBQXhCLENBREo7cUJBRlA7O0FBTUEsMkJBQU8sSUFBUCxDQUFZLENBQUMsTUFBRCxFQUFTLElBQUksS0FBSixDQUFVLEdBQVYsRUFBZSxPQUFPLENBQVAsQ0FBeEIsRUFDUixJQURRLEVBQ0YsTUFBTyxNQUFQLEVBQ04sSUFGUSxFQUVGLE9BQU8sTUFBUCxDQUZWLEVBVEc7QUFhSCwwQkFBTSxJQUFOLENBYkc7aUJBbkJBOztBQW1DUCxzQkEvREo7QUF0TEEsU0FUbUI7O0FBaVFuQixjQWpRbUI7S0FBdkI7O0FBb1FBLFdBQU8sTUFBUCxDQXBSb0M7Q0FBekIiLCJmaWxlIjoidG9rZW5pemUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBTSU5HTEVfUVVPVEUgICAgICA9ICdcXCcnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBET1VCTEVfUVVPVEUgICAgICA9ICAnXCInLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBCQUNLU0xBU0ggICAgICAgICA9ICdcXFxcJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgU0xBU0ggICAgICAgICAgICAgPSAgJy8nLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBORVdMSU5FICAgICAgICAgICA9ICdcXG4nLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBTUEFDRSAgICAgICAgICAgICA9ICAnICcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IEZFRUQgICAgICAgICAgICAgID0gJ1xcZicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFRBQiAgICAgICAgICAgICAgID0gJ1xcdCcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENSICAgICAgICAgICAgICAgID0gJ1xccicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IE9QRU5fUEFSRU5USEVTRVMgID0gICcoJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQ0xPU0VfUEFSRU5USEVTRVMgPSAgJyknLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBPUEVOX0NVUkxZICAgICAgICA9ICAneycuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENMT1NFX0NVUkxZICAgICAgID0gICd9Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgU0VNSUNPTE9OICAgICAgICAgPSAgJzsnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBBU1RFUklDSyAgICAgICAgICA9ICAnKicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENPTE9OICAgICAgICAgICAgID0gICc6Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQVQgICAgICAgICAgICAgICAgPSAgJ0AnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBDT01NQSAgICAgICAgICAgICA9ICAnLCcuY2hhckNvZGVBdCgwKTtcblxuY29uc3QgUkVfQVRfRU5EICAgICAgPSAvWyBcXG5cXHRcXHJcXGZcXHtcXChcXCknXCJcXFxcOy9dL2c7XG5jb25zdCBSRV9ORVdfTElORSAgICA9IC9bXFxyXFxmXFxuXS9nO1xuY29uc3QgUkVfV09SRF9FTkQgICAgPSAvWyBcXG5cXHRcXHJcXGZcXChcXClcXHtcXH06O0AhJ1wiXFxcXCxdfFxcLyg/PVxcKikvZztcbmNvbnN0IFJFX0JBRF9CUkFDS0VUID0gLy5bXFxcXFxcL1xcKFwiJ1xcbl0vO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0b2tlbml6ZShpbnB1dCkge1xuICAgIGxldCB0b2tlbnMgPSBbXTtcbiAgICBsZXQgY3NzICAgID0gaW5wdXQuY3NzLnZhbHVlT2YoKTtcblxuICAgIGxldCBjb2RlLCBuZXh0LCBxdW90ZSwgbGluZXMsIGxhc3QsIGNvbnRlbnQsIGVzY2FwZSxcbiAgICAgICAgbmV4dExpbmUsIG5leHRPZmZzZXQsIGVzY2FwZWQsIGVzY2FwZVBvcywgcHJldiwgbjtcblxuICAgIGxldCBsZW5ndGggPSBjc3MubGVuZ3RoO1xuICAgIGxldCBvZmZzZXQgPSAtMTtcbiAgICBsZXQgbGluZSAgID0gIDE7XG4gICAgbGV0IHBvcyAgICA9ICAwO1xuXG4gICAgZnVuY3Rpb24gdW5jbG9zZWQod2hhdCkge1xuICAgICAgICB0aHJvdyBpbnB1dC5lcnJvcignVW5jbG9zZWQgJyArIHdoYXQsIGxpbmUsIHBvcyAtIG9mZnNldCk7XG4gICAgfVxuXG4gICAgd2hpbGUgKCBwb3MgPCBsZW5ndGggKSB7XG4gICAgICAgIGNvZGUgPSBjc3MuY2hhckNvZGVBdChwb3MpO1xuXG4gICAgICAgIGlmICggY29kZSA9PT0gTkVXTElORSB8fCBjb2RlID09PSBGRUVEIHx8XG4gICAgICAgICAgICAgY29kZSA9PT0gQ1IgJiYgY3NzLmNoYXJDb2RlQXQocG9zICsgMSkgIT09IE5FV0xJTkUgKSB7XG4gICAgICAgICAgICBvZmZzZXQgPSBwb3M7XG4gICAgICAgICAgICBsaW5lICArPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgc3dpdGNoICggY29kZSApIHtcbiAgICAgICAgY2FzZSBDUjpcbiAgICAgICAgICAgIGlmICggY3NzLmNoYXJDb2RlQXQocG9zICsgMSkgPT09IE5FV0xJTkUgKSB7XG4gICAgICAgICAgICAgICAgb2Zmc2V0ID0gcG9zO1xuICAgICAgICAgICAgICAgIGxpbmUgICs9IDE7XG4gICAgICAgICAgICAgICAgcG9zICAgKz0gMTtcbiAgICAgICAgICAgICAgICB0b2tlbnMucHVzaChbJ25ld2xpbmUnLCAnXFxyXFxuJywgbGluZSAtIDFdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goWyduZXdsaW5lJywgJ1xccicsIGxpbmUgLSAxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEZFRUQ6XG4gICAgICAgIGNhc2UgTkVXTElORTpcbiAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnbmV3bGluZScsIGNzcy5zbGljZShwb3MsIHBvcyArIDEpLCBsaW5lIC0gMV0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cblxuICAgICAgICBjYXNlIFNQQUNFOlxuICAgICAgICBjYXNlIFRBQjpcbiAgICAgICAgICAgIG5leHQgPSBwb3M7XG4gICAgICAgICAgICBkbyB7XG4gICAgICAgICAgICAgICAgbmV4dCArPSAxO1xuICAgICAgICAgICAgICAgIGNvZGUgPSBjc3MuY2hhckNvZGVBdChuZXh0KTtcbiAgICAgICAgICAgIH0gd2hpbGUgKCBjb2RlID09PSBTUEFDRSB8fCBjb2RlID09PSBUQUIgKTtcblxuICAgICAgICAgICAgdG9rZW5zLnB1c2goWydzcGFjZScsIGNzcy5zbGljZShwb3MsIG5leHQpXSk7XG4gICAgICAgICAgICBwb3MgPSBuZXh0IC0gMTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgT1BFTl9DVVJMWTpcbiAgICAgICAgICAgIHRva2Vucy5wdXNoKFsneycsICd7JywgbGluZSwgcG9zIC0gb2Zmc2V0XSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIENMT1NFX0NVUkxZOlxuICAgICAgICAgICAgdG9rZW5zLnB1c2goWyd9JywgJ30nLCBsaW5lLCBwb3MgLSBvZmZzZXRdKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQ09MT046XG4gICAgICAgICAgICB0b2tlbnMucHVzaChbJzonLCAnOicsIGxpbmUsIHBvcyAtIG9mZnNldF0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBTRU1JQ09MT046XG4gICAgICAgICAgICB0b2tlbnMucHVzaChbJzsnLCAnOycsIGxpbmUsIHBvcyAtIG9mZnNldF0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBDT01NQTpcbiAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnLCcsICcsJywgbGluZSwgcG9zIC0gb2Zmc2V0XSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIE9QRU5fUEFSRU5USEVTRVM6XG4gICAgICAgICAgICBwcmV2ID0gdG9rZW5zLmxlbmd0aCA/IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV1bMV0gOiAnJztcbiAgICAgICAgICAgIG4gICAgPSBjc3MuY2hhckNvZGVBdChwb3MgKyAxKTtcbiAgICAgICAgICAgIGlmICggcHJldiA9PT0gJ3VybCcgJiYgbiAhPT0gU0lOR0xFX1FVT1RFICYmIG4gIT09IERPVUJMRV9RVU9URSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuICE9PSBTUEFDRSAmJiBuICE9PSBORVdMSU5FICYmIG4gIT09IFRBQiAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuICE9PSBGRUVEICYmIG4gIT09IENSICkge1xuICAgICAgICAgICAgICAgIG5leHQgPSBwb3M7XG4gICAgICAgICAgICAgICAgZG8ge1xuICAgICAgICAgICAgICAgICAgICBlc2NhcGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIG5leHQgICAgPSBjc3MuaW5kZXhPZignKScsIG5leHQgKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBuZXh0ID09PSAtMSApIHVuY2xvc2VkKCdicmFja2V0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGVzY2FwZVBvcyA9IG5leHQ7XG4gICAgICAgICAgICAgICAgICAgIHdoaWxlICggY3NzLmNoYXJDb2RlQXQoZXNjYXBlUG9zIC0gMSkgPT09IEJBQ0tTTEFTSCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVzY2FwZVBvcyAtPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSB3aGlsZSAoIGVzY2FwZWQgKTtcblxuICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnYnJhY2tldHMnLCBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSksXG4gICAgICAgICAgICAgICAgICAgIGxpbmUsIHBvcyAgLSBvZmZzZXQsXG4gICAgICAgICAgICAgICAgICAgIGxpbmUsIG5leHQgLSBvZmZzZXRcbiAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICBwb3MgPSBuZXh0O1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHQgICAgPSBjc3MuaW5kZXhPZignKScsIHBvcyArIDEpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIG5leHQgPT09IC0xIHx8IFJFX0JBRF9CUkFDS0VULnRlc3QoY29udGVudCkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnKCcsICcoJywgbGluZSwgcG9zIC0gb2Zmc2V0XSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goWydicmFja2V0cycsIGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lLCBwb3MgIC0gb2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZSwgbmV4dCAtIG9mZnNldFxuICAgICAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gbmV4dDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQ0xPU0VfUEFSRU5USEVTRVM6XG4gICAgICAgICAgICB0b2tlbnMucHVzaChbJyknLCAnKScsIGxpbmUsIHBvcyAtIG9mZnNldF0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBTSU5HTEVfUVVPVEU6XG4gICAgICAgIGNhc2UgRE9VQkxFX1FVT1RFOlxuICAgICAgICAgICAgcXVvdGUgPSBjb2RlID09PSBTSU5HTEVfUVVPVEUgPyAnXFwnJyA6ICdcIic7XG4gICAgICAgICAgICBuZXh0ICA9IHBvcztcbiAgICAgICAgICAgIGRvIHtcbiAgICAgICAgICAgICAgICBlc2NhcGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgbmV4dCAgICA9IGNzcy5pbmRleE9mKHF1b3RlLCBuZXh0ICsgMSk7XG4gICAgICAgICAgICAgICAgaWYgKCBuZXh0ID09PSAtMSApIHVuY2xvc2VkKCdxdW90ZScpO1xuICAgICAgICAgICAgICAgIGVzY2FwZVBvcyA9IG5leHQ7XG4gICAgICAgICAgICAgICAgd2hpbGUgKCBjc3MuY2hhckNvZGVBdChlc2NhcGVQb3MgLSAxKSA9PT0gQkFDS1NMQVNIICkge1xuICAgICAgICAgICAgICAgICAgICBlc2NhcGVQb3MgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gd2hpbGUgKCBlc2NhcGVkICk7XG5cbiAgICAgICAgICAgIGNvbnRlbnQgPSBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSk7XG4gICAgICAgICAgICBsaW5lcyAgID0gY29udGVudC5zcGxpdCgnXFxuJyk7XG4gICAgICAgICAgICBsYXN0ICAgID0gbGluZXMubGVuZ3RoIC0gMTtcblxuICAgICAgICAgICAgaWYgKCBsYXN0ID4gMCApIHtcbiAgICAgICAgICAgICAgICBuZXh0TGluZSAgID0gbGluZSArIGxhc3Q7XG4gICAgICAgICAgICAgICAgbmV4dE9mZnNldCA9IG5leHQgLSBsaW5lc1tsYXN0XS5sZW5ndGg7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHRMaW5lICAgPSBsaW5lO1xuICAgICAgICAgICAgICAgIG5leHRPZmZzZXQgPSBvZmZzZXQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnc3RyaW5nJywgY3NzLnNsaWNlKHBvcywgbmV4dCArIDEpLFxuICAgICAgICAgICAgICAgIGxpbmUsIHBvcyAgLSBvZmZzZXQsXG4gICAgICAgICAgICAgICAgbmV4dExpbmUsIG5leHQgLSBuZXh0T2Zmc2V0XG4gICAgICAgICAgICBdKTtcblxuICAgICAgICAgICAgb2Zmc2V0ID0gbmV4dE9mZnNldDtcbiAgICAgICAgICAgIGxpbmUgICA9IG5leHRMaW5lO1xuICAgICAgICAgICAgcG9zICAgID0gbmV4dDtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQVQ6XG4gICAgICAgICAgICBSRV9BVF9FTkQubGFzdEluZGV4ID0gcG9zICsgMTtcbiAgICAgICAgICAgIFJFX0FUX0VORC50ZXN0KGNzcyk7XG4gICAgICAgICAgICBpZiAoIFJFX0FUX0VORC5sYXN0SW5kZXggPT09IDAgKSB7XG4gICAgICAgICAgICAgICAgbmV4dCA9IGNzcy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0ID0gUkVfQVRfRU5ELmxhc3RJbmRleCAtIDI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0b2tlbnMucHVzaChbJ2F0LXdvcmQnLCBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSksXG4gICAgICAgICAgICAgICAgbGluZSwgcG9zICAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICBsaW5lLCBuZXh0IC0gb2Zmc2V0XG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIHBvcyA9IG5leHQ7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEJBQ0tTTEFTSDpcbiAgICAgICAgICAgIG5leHQgICA9IHBvcztcbiAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7XG5cbiAgICAgICAgICAgIG5leHRMaW5lID0gbGluZTtcblxuICAgICAgICAgICAgd2hpbGUgKCBjc3MuY2hhckNvZGVBdChuZXh0ICsgMSkgPT09IEJBQ0tTTEFTSCApIHtcbiAgICAgICAgICAgICAgICBuZXh0ICArPSAxO1xuICAgICAgICAgICAgICAgIGVzY2FwZSA9ICFlc2NhcGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb2RlID0gY3NzLmNoYXJDb2RlQXQobmV4dCArIDEpO1xuICAgICAgICAgICAgaWYgKCBlc2NhcGUgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCBjb2RlID09PSBDUiAmJiBjc3MuY2hhckNvZGVBdChuZXh0ICsgMikgPT09IE5FV0xJTkUgKSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHQgICAgICArPSAyO1xuICAgICAgICAgICAgICAgICAgICBuZXh0TGluZSAgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dE9mZnNldCA9IG5leHQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICggY29kZSA9PT0gQ1IgfHwgY29kZSA9PT0gTkVXTElORSB8fCBjb2RlID09PSBGRUVEICkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0ICAgICAgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dExpbmUgICs9IDE7XG4gICAgICAgICAgICAgICAgICAgIG5leHRPZmZzZXQgPSBuZXh0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHQgKz0gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0b2tlbnMucHVzaChbJ3dvcmQnLCBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSksXG4gICAgICAgICAgICAgICAgbGluZSwgcG9zICAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICBsaW5lLCBuZXh0IC0gb2Zmc2V0XG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIGlmICggbmV4dExpbmUgIT09IGxpbmUgKSB7XG4gICAgICAgICAgICAgICAgbGluZSAgID0gbmV4dExpbmU7XG4gICAgICAgICAgICAgICAgb2Zmc2V0ID0gbmV4dE9mZnNldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBvcyA9IG5leHQ7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgbiA9IGNzcy5jaGFyQ29kZUF0KHBvcyArIDEpO1xuXG4gICAgICAgICAgICBpZiAoIGNvZGUgPT09IFNMQVNIICYmIG4gPT09IEFTVEVSSUNLICkge1xuICAgICAgICAgICAgICAgIG5leHQgPSBjc3MuaW5kZXhPZignKi8nLCBwb3MgKyAyKSArIDE7XG4gICAgICAgICAgICAgICAgaWYgKCBuZXh0ID09PSAwICkgdW5jbG9zZWQoJ2NvbW1lbnQnKTtcblxuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjc3Muc2xpY2UocG9zLCBuZXh0ICsgMSk7XG4gICAgICAgICAgICAgICAgbGluZXMgICA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpO1xuICAgICAgICAgICAgICAgIGxhc3QgICAgPSBsaW5lcy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgICAgICAgaWYgKCBsYXN0ID4gMCApIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dExpbmUgICA9IGxpbmUgKyBsYXN0O1xuICAgICAgICAgICAgICAgICAgICBuZXh0T2Zmc2V0ID0gbmV4dCAtIGxpbmVzW2xhc3RdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXh0TGluZSAgID0gbGluZTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dE9mZnNldCA9IG9mZnNldDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0b2tlbnMucHVzaChbJ2NvbW1lbnQnLCBjb250ZW50LFxuICAgICAgICAgICAgICAgICAgICBsaW5lLCAgICAgcG9zICAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgbmV4dExpbmUsIG5leHQgLSBuZXh0T2Zmc2V0XG4gICAgICAgICAgICAgICAgXSk7XG5cbiAgICAgICAgICAgICAgICBvZmZzZXQgPSBuZXh0T2Zmc2V0O1xuICAgICAgICAgICAgICAgIGxpbmUgICA9IG5leHRMaW5lO1xuICAgICAgICAgICAgICAgIHBvcyAgICA9IG5leHQ7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGNvZGUgPT09IFNMQVNIICYmIG4gPT09IFNMQVNIICkge1xuICAgICAgICAgICAgICAgIFJFX05FV19MSU5FLmxhc3RJbmRleCA9IHBvcyArIDE7XG4gICAgICAgICAgICAgICAgUkVfTkVXX0xJTkUudGVzdChjc3MpO1xuICAgICAgICAgICAgICAgIGlmICggUkVfTkVXX0xJTkUubGFzdEluZGV4ID09PSAwICkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0ID0gY3NzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IFJFX05FV19MSU5FLmxhc3RJbmRleCAtIDI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29udGVudCA9IGNzcy5zbGljZShwb3MsIG5leHQgKyAxKTtcblxuICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKFsnY29tbWVudCcsIGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgIGxpbmUsIHBvcyAgLSBvZmZzZXQsXG4gICAgICAgICAgICAgICAgICAgIGxpbmUsIG5leHQgLSBvZmZzZXQsXG4gICAgICAgICAgICAgICAgICAgICdpbmxpbmUnXG4gICAgICAgICAgICAgICAgXSk7XG5cbiAgICAgICAgICAgICAgICBwb3MgPSBuZXh0O1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIFJFX1dPUkRfRU5ELmxhc3RJbmRleCA9IHBvcyArIDE7XG4gICAgICAgICAgICAgICAgUkVfV09SRF9FTkQudGVzdChjc3MpO1xuICAgICAgICAgICAgICAgIGlmICggUkVfV09SRF9FTkQubGFzdEluZGV4ID09PSAwICkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0ID0gY3NzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IFJFX1dPUkRfRU5ELmxhc3RJbmRleCAtIDI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goWyd3b3JkJywgY3NzLnNsaWNlKHBvcywgbmV4dCArIDEpLFxuICAgICAgICAgICAgICAgICAgICBsaW5lLCBwb3MgIC0gb2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICBsaW5lLCBuZXh0IC0gb2Zmc2V0XG4gICAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICAgICAgcG9zID0gbmV4dDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBwb3MrKztcbiAgICB9XG5cbiAgICByZXR1cm4gdG9rZW5zO1xufVxuIl19