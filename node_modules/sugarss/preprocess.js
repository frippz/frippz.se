'use strict';

exports.__esModule = true;
exports.default = preprocess;
function indentError(input, l, p) {
    throw input.error('Mixed tabs and spaces are not allowed', l, p + 1);
}

function preprocess(input, lines) {
    var indentType = void 0;
    var prevNumber = 0;
    var parts = lines.map(function (line) {
        var lastComma = false;
        var comment = false;
        var number = prevNumber + 1;
        var atrule = false;
        var indent = '';
        var tokens = [];
        var colon = false;

        if (line.length > 0) {
            if (line[0][0] === 'space') {
                indent = line[0][1];
                tokens = line.slice(1);
            } else {
                indent = '';
                tokens = line;
            }

            if (!indentType && indent.length) {
                indentType = indent[0] === ' ' ? 'space' : 'tab';
            }
            if (indentType === 'space') {
                if (indent.indexOf('\t') !== -1) {
                    indentError(input, number, indent.indexOf('\t'));
                }
            } else if (indentType === 'tab') {
                if (indent.indexOf(' ') !== -1) {
                    indentError(input, number, indent.indexOf(' '));
                }
            }

            if (tokens.length) {
                for (var i = tokens.length - 1; i >= 0; i--) {
                    var type = tokens[i][0];
                    if (type === ',') {
                        lastComma = true;
                        break;
                    } else if (type === 'space') {
                        continue;
                    } else if (type === 'comment') {
                        continue;
                    } else if (type === 'newline') {
                        continue;
                    } else {
                        break;
                    }
                }
                comment = tokens[0][0] === 'comment';
                atrule = tokens[0][0] === 'at-word';

                var brackets = 0;
                for (var _i = 0; _i < tokens.length - 1; _i++) {
                    var _type = tokens[_i][0];
                    var next = tokens[_i + 1][0];
                    if (_type === '(') {
                        brackets += 1;
                    } else if (_type === ')') {
                        brackets -= 1;
                    } else if (_type === ':' && brackets === 0 && (next === 'space' || next === 'newline')) {
                        colon = true;
                    }
                }
            }

            var last = tokens[tokens.length - 1];
            if (last && last[0] === 'newline') prevNumber = last[2];
        }

        return {
            number: number,
            indent: indent,
            colon: colon,
            tokens: tokens,
            atrule: atrule,
            comment: comment,
            lastComma: lastComma,
            before: ''
        };
    });

    parts = parts.reduceRight(function (all, i) {
        if (!i.tokens.length || i.tokens.every(function (j) {
            return j[0] === 'newline';
        })) {
            var prev = all[0];
            var before = i.indent + i.tokens.map(function (j) {
                return j[1];
            }).join('');
            prev.before = before + prev.before;
        } else {
            all.unshift(i);
        }
        return all;
    }, [{ end: true, before: '' }]);

    parts.forEach(function (part, i) {
        if (i === 0) return;

        var prev = parts[i - 1];
        var last = prev.tokens[prev.tokens.length - 1];
        if (last && last[0] === 'newline') {
            part.before = last[1] + part.before;
            prev.tokens.pop();
        }
    });

    return parts;
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByZXByb2Nlc3MuZXM2Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztrQkFJd0I7QUFKeEIsU0FBUyxXQUFULENBQXFCLEtBQXJCLEVBQTRCLENBQTVCLEVBQStCLENBQS9CLEVBQWtDO0FBQzlCLFVBQU0sTUFBTSxLQUFOLENBQVksdUNBQVosRUFBcUQsQ0FBckQsRUFBd0QsSUFBSSxDQUFKLENBQTlELENBRDhCO0NBQWxDOztBQUllLFNBQVMsVUFBVCxDQUFvQixLQUFwQixFQUEyQixLQUEzQixFQUFrQztBQUM3QyxRQUFJLG1CQUFKLENBRDZDO0FBRTdDLFFBQUksYUFBYSxDQUFiLENBRnlDO0FBRzdDLFFBQUksUUFBUSxNQUFNLEdBQU4sQ0FBVSxnQkFBUTtBQUMxQixZQUFJLFlBQVksS0FBWixDQURzQjtBQUUxQixZQUFJLFVBQVksS0FBWixDQUZzQjtBQUcxQixZQUFJLFNBQVksYUFBYSxDQUFiLENBSFU7QUFJMUIsWUFBSSxTQUFZLEtBQVosQ0FKc0I7QUFLMUIsWUFBSSxTQUFZLEVBQVosQ0FMc0I7QUFNMUIsWUFBSSxTQUFZLEVBQVosQ0FOc0I7QUFPMUIsWUFBSSxRQUFZLEtBQVosQ0FQc0I7O0FBUzFCLFlBQUssS0FBSyxNQUFMLEdBQWMsQ0FBZCxFQUFrQjtBQUNuQixnQkFBSyxLQUFLLENBQUwsRUFBUSxDQUFSLE1BQWUsT0FBZixFQUF5QjtBQUMxQix5QkFBUyxLQUFLLENBQUwsRUFBUSxDQUFSLENBQVQsQ0FEMEI7QUFFMUIseUJBQVMsS0FBSyxLQUFMLENBQVcsQ0FBWCxDQUFULENBRjBCO2FBQTlCLE1BR087QUFDSCx5QkFBUyxFQUFULENBREc7QUFFSCx5QkFBUyxJQUFULENBRkc7YUFIUDs7QUFRQSxnQkFBSyxDQUFDLFVBQUQsSUFBZSxPQUFPLE1BQVAsRUFBZ0I7QUFDaEMsNkJBQWEsT0FBTyxDQUFQLE1BQWMsR0FBZCxHQUFvQixPQUFwQixHQUE4QixLQUE5QixDQURtQjthQUFwQztBQUdBLGdCQUFLLGVBQWUsT0FBZixFQUF5QjtBQUMxQixvQkFBSyxPQUFPLE9BQVAsQ0FBZSxJQUFmLE1BQXlCLENBQUMsQ0FBRCxFQUFLO0FBQy9CLGdDQUFZLEtBQVosRUFBbUIsTUFBbkIsRUFBMkIsT0FBTyxPQUFQLENBQWUsSUFBZixDQUEzQixFQUQrQjtpQkFBbkM7YUFESixNQUlPLElBQUssZUFBZSxLQUFmLEVBQXVCO0FBQy9CLG9CQUFLLE9BQU8sT0FBUCxDQUFlLEdBQWYsTUFBd0IsQ0FBQyxDQUFELEVBQUs7QUFDOUIsZ0NBQVksS0FBWixFQUFtQixNQUFuQixFQUEyQixPQUFPLE9BQVAsQ0FBZSxHQUFmLENBQTNCLEVBRDhCO2lCQUFsQzthQURHOztBQU1QLGdCQUFLLE9BQU8sTUFBUCxFQUFnQjtBQUNqQixxQkFBTSxJQUFJLElBQUksT0FBTyxNQUFQLEdBQWdCLENBQWhCLEVBQW1CLEtBQUssQ0FBTCxFQUFRLEdBQXpDLEVBQWdEO0FBQzVDLHdCQUFJLE9BQU8sT0FBTyxDQUFQLEVBQVUsQ0FBVixDQUFQLENBRHdDO0FBRTVDLHdCQUFLLFNBQVMsR0FBVCxFQUFlO0FBQ2hCLG9DQUFZLElBQVosQ0FEZ0I7QUFFaEIsOEJBRmdCO3FCQUFwQixNQUdPLElBQUssU0FBUyxPQUFULEVBQW1CO0FBQzNCLGlDQUQyQjtxQkFBeEIsTUFFQSxJQUFLLFNBQVMsU0FBVCxFQUFxQjtBQUM3QixpQ0FENkI7cUJBQTFCLE1BRUEsSUFBSyxTQUFTLFNBQVQsRUFBcUI7QUFDN0IsaUNBRDZCO3FCQUExQixNQUVBO0FBQ0gsOEJBREc7cUJBRkE7aUJBVFg7QUFlQSwwQkFBVSxPQUFPLENBQVAsRUFBVSxDQUFWLE1BQWlCLFNBQWpCLENBaEJPO0FBaUJqQix5QkFBVSxPQUFPLENBQVAsRUFBVSxDQUFWLE1BQWlCLFNBQWpCLENBakJPOztBQW1CakIsb0JBQUksV0FBVyxDQUFYLENBbkJhO0FBb0JqQixxQkFBTSxJQUFJLEtBQUksQ0FBSixFQUFPLEtBQUksT0FBTyxNQUFQLEdBQWdCLENBQWhCLEVBQW1CLElBQXhDLEVBQThDO0FBQzFDLHdCQUFJLFFBQU8sT0FBTyxFQUFQLEVBQVUsQ0FBVixDQUFQLENBRHNDO0FBRTFDLHdCQUFJLE9BQU8sT0FBTyxLQUFJLENBQUosQ0FBUCxDQUFjLENBQWQsQ0FBUCxDQUZzQztBQUcxQyx3QkFBSyxVQUFTLEdBQVQsRUFBZTtBQUNoQixvQ0FBWSxDQUFaLENBRGdCO3FCQUFwQixNQUVPLElBQUssVUFBUyxHQUFULEVBQWU7QUFDdkIsb0NBQVksQ0FBWixDQUR1QjtxQkFBcEIsTUFFQSxJQUFLLFVBQVMsR0FBVCxJQUFnQixhQUFhLENBQWIsS0FDaEIsU0FBUyxPQUFULElBQW9CLFNBQVMsU0FBVCxDQURwQixFQUMwQztBQUNsRCxnQ0FBUSxJQUFSLENBRGtEO3FCQUQvQztpQkFQWDthQXBCSjs7QUFrQ0EsZ0JBQUksT0FBTyxPQUFPLE9BQU8sTUFBUCxHQUFnQixDQUFoQixDQUFkLENBeERlO0FBeURuQixnQkFBSyxRQUFRLEtBQUssQ0FBTCxNQUFZLFNBQVosRUFBd0IsYUFBYSxLQUFLLENBQUwsQ0FBYixDQUFyQztTQXpESjs7QUE0REEsZUFBTztBQUNILDBCQURHO0FBRUgsMEJBRkc7QUFHSCx3QkFIRztBQUlILDBCQUpHO0FBS0gsMEJBTEc7QUFNSCw0QkFORztBQU9ILGdDQVBHO0FBUUgsb0JBQVEsRUFBUjtTQVJKLENBckUwQjtLQUFSLENBQWxCLENBSHlDOztBQW9GN0MsWUFBUSxNQUFNLFdBQU4sQ0FBbUIsVUFBQyxHQUFELEVBQU0sQ0FBTixFQUFZO0FBQ25DLFlBQUssQ0FBQyxFQUFFLE1BQUYsQ0FBUyxNQUFULElBQW1CLEVBQUUsTUFBRixDQUFTLEtBQVQsQ0FBZTttQkFBSyxFQUFFLENBQUYsTUFBUyxTQUFUO1NBQUwsQ0FBbkMsRUFBOEQ7QUFDL0QsZ0JBQUksT0FBVSxJQUFJLENBQUosQ0FBVixDQUQyRDtBQUUvRCxnQkFBSSxTQUFVLEVBQUUsTUFBRixHQUFXLEVBQUUsTUFBRixDQUFTLEdBQVQsQ0FBYzt1QkFBSyxFQUFFLENBQUY7YUFBTCxDQUFkLENBQTBCLElBQTFCLENBQStCLEVBQS9CLENBQVgsQ0FGaUQ7QUFHL0QsaUJBQUssTUFBTCxHQUFjLFNBQVMsS0FBSyxNQUFMLENBSHdDO1NBQW5FLE1BSU87QUFDSCxnQkFBSSxPQUFKLENBQVksQ0FBWixFQURHO1NBSlA7QUFPQSxlQUFPLEdBQVAsQ0FSbUM7S0FBWixFQVN4QixDQUFDLEVBQUUsS0FBSyxJQUFMLEVBQVcsUUFBUSxFQUFSLEVBQWQsQ0FUSyxDQUFSLENBcEY2Qzs7QUErRjdDLFVBQU0sT0FBTixDQUFlLFVBQUMsSUFBRCxFQUFPLENBQVAsRUFBYTtBQUN4QixZQUFLLE1BQU0sQ0FBTixFQUFVLE9BQWY7O0FBRUEsWUFBSSxPQUFPLE1BQU0sSUFBSSxDQUFKLENBQWIsQ0FIb0I7QUFJeEIsWUFBSSxPQUFPLEtBQUssTUFBTCxDQUFZLEtBQUssTUFBTCxDQUFZLE1BQVosR0FBcUIsQ0FBckIsQ0FBbkIsQ0FKb0I7QUFLeEIsWUFBSyxRQUFRLEtBQUssQ0FBTCxNQUFZLFNBQVosRUFBd0I7QUFDakMsaUJBQUssTUFBTCxHQUFjLEtBQUssQ0FBTCxJQUFVLEtBQUssTUFBTCxDQURTO0FBRWpDLGlCQUFLLE1BQUwsQ0FBWSxHQUFaLEdBRmlDO1NBQXJDO0tBTFcsQ0FBZixDQS9GNkM7O0FBMEc3QyxXQUFPLEtBQVAsQ0ExRzZDO0NBQWxDIiwiZmlsZSI6InByZXByb2Nlc3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJmdW5jdGlvbiBpbmRlbnRFcnJvcihpbnB1dCwgbCwgcCkge1xuICAgIHRocm93IGlucHV0LmVycm9yKCdNaXhlZCB0YWJzIGFuZCBzcGFjZXMgYXJlIG5vdCBhbGxvd2VkJywgbCwgcCArIDEpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwcmVwcm9jZXNzKGlucHV0LCBsaW5lcykge1xuICAgIGxldCBpbmRlbnRUeXBlO1xuICAgIGxldCBwcmV2TnVtYmVyID0gMDtcbiAgICBsZXQgcGFydHMgPSBsaW5lcy5tYXAobGluZSA9PiB7XG4gICAgICAgIGxldCBsYXN0Q29tbWEgPSBmYWxzZTtcbiAgICAgICAgbGV0IGNvbW1lbnQgICA9IGZhbHNlO1xuICAgICAgICBsZXQgbnVtYmVyICAgID0gcHJldk51bWJlciArIDE7XG4gICAgICAgIGxldCBhdHJ1bGUgICAgPSBmYWxzZTtcbiAgICAgICAgbGV0IGluZGVudCAgICA9ICcnO1xuICAgICAgICBsZXQgdG9rZW5zICAgID0gW107XG4gICAgICAgIGxldCBjb2xvbiAgICAgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIGxpbmUubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgIGlmICggbGluZVswXVswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgICAgICBpbmRlbnQgPSBsaW5lWzBdWzFdO1xuICAgICAgICAgICAgICAgIHRva2VucyA9IGxpbmUuc2xpY2UoMSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluZGVudCA9ICcnO1xuICAgICAgICAgICAgICAgIHRva2VucyA9IGxpbmU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICggIWluZGVudFR5cGUgJiYgaW5kZW50Lmxlbmd0aCApIHtcbiAgICAgICAgICAgICAgICBpbmRlbnRUeXBlID0gaW5kZW50WzBdID09PSAnICcgPyAnc3BhY2UnIDogJ3RhYic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIGluZGVudFR5cGUgPT09ICdzcGFjZScgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCBpbmRlbnQuaW5kZXhPZignXFx0JykgIT09IC0xICkge1xuICAgICAgICAgICAgICAgICAgICBpbmRlbnRFcnJvcihpbnB1dCwgbnVtYmVyLCBpbmRlbnQuaW5kZXhPZignXFx0JykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGluZGVudFR5cGUgPT09ICd0YWInICkge1xuICAgICAgICAgICAgICAgIGlmICggaW5kZW50LmluZGV4T2YoJyAnKSAhPT0gLTEgKSB7XG4gICAgICAgICAgICAgICAgICAgIGluZGVudEVycm9yKGlucHV0LCBudW1iZXIsIGluZGVudC5pbmRleE9mKCcgJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCB0b2tlbnMubGVuZ3RoICkge1xuICAgICAgICAgICAgICAgIGZvciAoIGxldCBpID0gdG9rZW5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0b2tlbnNbaV1bMF07XG4gICAgICAgICAgICAgICAgICAgIGlmICggdHlwZSA9PT0gJywnICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdENvbW1hID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCB0eXBlID09PSAnc3BhY2UnICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHR5cGUgPT09ICdjb21tZW50JyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCB0eXBlID09PSAnbmV3bGluZScgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbW1lbnQgPSB0b2tlbnNbMF1bMF0gPT09ICdjb21tZW50JztcbiAgICAgICAgICAgICAgICBhdHJ1bGUgID0gdG9rZW5zWzBdWzBdID09PSAnYXQtd29yZCc7XG5cbiAgICAgICAgICAgICAgICBsZXQgYnJhY2tldHMgPSAwO1xuICAgICAgICAgICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGggLSAxOyBpKysgKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdG9rZW5zW2ldWzBdO1xuICAgICAgICAgICAgICAgICAgICBsZXQgbmV4dCA9IHRva2Vuc1tpICsgMV1bMF07XG4gICAgICAgICAgICAgICAgICAgIGlmICggdHlwZSA9PT0gJygnICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJhY2tldHMgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggdHlwZSA9PT0gJyknICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJhY2tldHMgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggdHlwZSA9PT0gJzonICYmIGJyYWNrZXRzID09PSAwICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5leHQgPT09ICdzcGFjZScgfHwgbmV4dCA9PT0gJ25ld2xpbmUnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGxhc3QgPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgaWYgKCBsYXN0ICYmIGxhc3RbMF0gPT09ICduZXdsaW5lJyApIHByZXZOdW1iZXIgPSBsYXN0WzJdO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG51bWJlcixcbiAgICAgICAgICAgIGluZGVudCxcbiAgICAgICAgICAgIGNvbG9uLFxuICAgICAgICAgICAgdG9rZW5zLFxuICAgICAgICAgICAgYXRydWxlLFxuICAgICAgICAgICAgY29tbWVudCxcbiAgICAgICAgICAgIGxhc3RDb21tYSxcbiAgICAgICAgICAgIGJlZm9yZTogJydcbiAgICAgICAgfTtcbiAgICB9KTtcblxuICAgIHBhcnRzID0gcGFydHMucmVkdWNlUmlnaHQoIChhbGwsIGkpID0+IHtcbiAgICAgICAgaWYgKCAhaS50b2tlbnMubGVuZ3RoIHx8IGkudG9rZW5zLmV2ZXJ5KGogPT4galswXSA9PT0gJ25ld2xpbmUnKSApIHtcbiAgICAgICAgICAgIGxldCBwcmV2ICAgID0gYWxsWzBdO1xuICAgICAgICAgICAgbGV0IGJlZm9yZSAgPSBpLmluZGVudCArIGkudG9rZW5zLm1hcCggaiA9PiBqWzFdICkuam9pbignJyk7XG4gICAgICAgICAgICBwcmV2LmJlZm9yZSA9IGJlZm9yZSArIHByZXYuYmVmb3JlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWxsLnVuc2hpZnQoaSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFsbDtcbiAgICB9LCBbeyBlbmQ6IHRydWUsIGJlZm9yZTogJycgfV0pO1xuXG4gICAgcGFydHMuZm9yRWFjaCggKHBhcnQsIGkpID0+IHtcbiAgICAgICAgaWYgKCBpID09PSAwICkgcmV0dXJuO1xuXG4gICAgICAgIGxldCBwcmV2ID0gcGFydHNbaSAtIDFdO1xuICAgICAgICBsZXQgbGFzdCA9IHByZXYudG9rZW5zW3ByZXYudG9rZW5zLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAoIGxhc3QgJiYgbGFzdFswXSA9PT0gJ25ld2xpbmUnICkge1xuICAgICAgICAgICAgcGFydC5iZWZvcmUgPSBsYXN0WzFdICsgcGFydC5iZWZvcmU7XG4gICAgICAgICAgICBwcmV2LnRva2Vucy5wb3AoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhcnRzO1xufVxuIl19