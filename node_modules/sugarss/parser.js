'use strict';

exports.__esModule = true;

var _declaration = require('postcss/lib/declaration');

var _declaration2 = _interopRequireDefault(_declaration);

var _comment = require('postcss/lib/comment');

var _comment2 = _interopRequireDefault(_comment);

var _atRule = require('postcss/lib/at-rule');

var _atRule2 = _interopRequireDefault(_atRule);

var _rule = require('postcss/lib/rule');

var _rule2 = _interopRequireDefault(_rule);

var _root = require('postcss/lib/root');

var _root2 = _interopRequireDefault(_root);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Parser = function () {
    function Parser(input) {
        _classCallCheck(this, Parser);

        this.input = input;

        this.pos = 0;
        this.root = new _root2.default();
        this.current = this.root;
        this.spaces = '';

        this.prevIndent = undefined;
        this.step = undefined;

        this.root.source = { input: input, start: { line: 1, column: 1 } };
    }

    Parser.prototype.loop = function loop() {
        var part = void 0;
        while (this.pos < this.parts.length) {
            part = this.parts[this.pos];

            if (part.comment) {
                this.comment(part);
            } else if (part.atrule) {
                this.atrule(part);
            } else if (part.colon) {
                var next = this.nextNonComment(this.pos);

                if (next.end || next.atrule) {
                    this.decl(part);
                } else {
                    var sameIndent = next.indent.length === part.indent.length;
                    if (sameIndent) {
                        this.decl(part);
                    } else if (!sameIndent && next.colon) {
                        this.rule(part);
                    } else if (!sameIndent && !next.colon) {
                        this.decl(part);
                    }
                }
            } else if (part.end) {
                this.root.raws.after = part.before;
            } else {
                this.rule(part);
            }

            this.pos += 1;
        }
    };

    Parser.prototype.comment = function comment(part) {
        var token = part.tokens[0];
        var node = new _comment2.default();
        this.init(node, part);
        node.source.end = { line: token[4], column: token[5] };

        var text = token[1];
        if (token[6] === 'inline') {
            node.raws.inline = true;
            text = text.slice(2);
        } else {
            text = text.slice(2, -2);
        }

        var match = text.match(/^(\s*)([^]*[^\s])(\s*)\n?$/);
        node.text = match[2];
        node.raws.left = match[1];
        node.raws.inlineRight = match[3];
    };

    Parser.prototype.atrule = function atrule(part) {
        var atword = part.tokens[0];
        var params = part.tokens.slice(1);

        var node = new _atRule2.default();
        node.name = atword[1].slice(1);
        this.init(node, part);

        if (node.name === '') this.unnamedAtrule(atword);

        while (!part.end && part.lastComma) {
            this.pos += 1;
            part = this.parts[this.pos];
            params.push(['space', part.before + part.indent]);
            params = params.concat(part.tokens);
        }

        node.raws.afterName = this.firstSpaces(params);
        this.keepTrailingSpace(node, params);
        this.raw(node, 'params', params, atword);
    };

    Parser.prototype.decl = function decl(part) {
        var node = new _declaration2.default();
        this.init(node, part);

        var between = '';
        var colon = 0;
        var value = [];
        var prop = '';
        for (var i = 0; i < part.tokens.length; i++) {
            var token = part.tokens[i];
            if (token[0] === ':') {
                between += token[1];
                colon = token;
                value = part.tokens.slice(i + 1);
                break;
            } else if (token[0] === 'comment' || token[0] === 'space') {
                between += token[1];
            } else if (between !== '') {
                this.badProp(token);
            } else {
                prop += token[1];
            }
        }

        if (prop === '') this.unnamedDecl(part.tokens[0]);
        node.prop = prop;

        var next = this.parts[this.pos + 1];

        while (!next.end && !next.atrule && !next.colon && next.indent.length > part.indent.length) {
            value.push(['space', next.before + next.indent]);
            value = value.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        for (var _i = value.length - 1; _i > 0; _i--) {
            var t = value[_i][0];
            if (t === 'word' && value[_i][1] === '!important') {
                node.important = true;
                if (_i > 0 && value[_i - 1][0] === 'space') {
                    node.raws.important = value[_i - 1][1] + '!important';
                    value.splice(_i - 1, 2);
                } else {
                    node.raws.important = '!important';
                    value.splice(_i, 1);
                }
                break;
            } else if (t !== 'space' && t !== 'newline' && t !== 'comment') {
                break;
            }
        }

        node.raws.between = between + this.firstSpaces(value);
        this.raw(node, 'value', value, colon);
    };

    Parser.prototype.rule = function rule(part) {
        var node = new _rule2.default();
        this.init(node, part);

        var selector = part.tokens;
        var next = this.parts[this.pos + 1];

        while (!next.end && next.indent.length === part.indent.length) {
            selector.push(['space', next.before + next.indent]);
            selector = selector.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        this.keepTrailingSpace(node, selector);
        this.raw(node, 'selector', selector);
    };

    /* Helpers */

    Parser.prototype.indent = function indent(part) {
        var indent = part.indent.length;
        var isPrev = typeof this.prevIndent !== 'undefined';

        if (!isPrev && indent) this.indentedFirstLine(part);

        if (!this.step && indent) {
            this.step = indent;
            this.root.raws.indent = part.indent;
        }

        if (isPrev && this.prevIndent !== indent) {
            var diff = indent - this.prevIndent;
            if (diff > 0) {
                if (diff !== this.step) {
                    this.wrongIndent(this.prevIndent + this.step, indent, part);
                } else {
                    this.current = this.current.last;
                }
            } else if (diff % this.step !== 0) {
                var m = indent + diff % this.step;
                this.wrongIndent(m + ' or ' + (m + this.step), indent, part);
            } else {
                for (var i = 0; i < -diff / this.step; i++) {
                    this.current = this.current.parent;
                }
            }
        }

        this.prevIndent = indent;
    };

    Parser.prototype.init = function init(node, part) {
        this.indent(part);

        if (!this.current.nodes) this.current.nodes = [];
        this.current.push(node);

        node.raws.before = part.before + part.indent;
        node.source = {
            start: { line: part.tokens[0][2], column: part.tokens[0][3] },
            input: this.input
        };
    };

    Parser.prototype.keepTrailingSpace = function keepTrailingSpace(node, tokens) {
        var lastSpace = tokens[tokens.length - 1];
        if (lastSpace && lastSpace[0] === 'space') {
            tokens.pop();
            node.raws.sssBetween = lastSpace[1];
        }
    };

    Parser.prototype.firstSpaces = function firstSpaces(tokens) {
        var result = '';
        for (var i = 0; i < tokens.length; i++) {
            if (tokens[i][0] === 'space' || tokens[i][0] === 'newline') {
                result += tokens.shift()[1];
                i -= 1;
            } else {
                break;
            }
        }
        return result;
    };

    Parser.prototype.raw = function raw(node, prop, tokens, altLast) {
        var token = void 0,
            type = void 0;
        var length = tokens.length;
        var value = '';
        var clean = true;
        for (var i = 0; i < length; i += 1) {
            token = tokens[i];
            type = token[0];
            if (type === 'comment' || type === 'space' && i === length - 1) {
                clean = false;
            } else {
                value += token[1];
            }
        }
        if (!clean) {
            var sss = tokens.reduce(function (all, i) {
                return all + i[1];
            }, '');
            var raw = tokens.reduce(function (all, i) {
                if (i[0] === 'comment' && i[6] === 'inline') {
                    return all + '/* ' + i[1].slice(2).trim() + ' */';
                } else {
                    return all + i[1];
                }
            }, '');
            node.raws[prop] = { value: value, raw: raw };
            if (sss !== raw) node.raws[prop].sss = sss;
        }
        node[prop] = value;

        var last = tokens[tokens.length - 1] || altLast;
        node.source.end = { line: last[4], column: last[5] };
    };

    Parser.prototype.nextNonComment = function nextNonComment(pos) {
        var next = pos;
        var part = void 0;
        while (next < this.parts.length) {
            next += 1;
            part = this.parts[next];
            if (part.end || !part.comment) break;
        }
        return part;
    };

    // Errors

    Parser.prototype.error = function error(msg, line, column) {
        throw this.input.error(msg, line, column);
    };

    Parser.prototype.unnamedAtrule = function unnamedAtrule(token) {
        this.error('At-rule without name', token[2], token[3]);
    };

    Parser.prototype.unnamedDecl = function unnamedDecl(token) {
        this.error('Declaration without name', token[2], token[3]);
    };

    Parser.prototype.indentedFirstLine = function indentedFirstLine(part) {
        this.error('First line should not have indent', part.number, 1);
    };

    Parser.prototype.wrongIndent = function wrongIndent(expected, real, part) {
        var msg = 'Expected ' + expected + ' indent, but get ' + real;
        this.error(msg, part.number, 1);
    };

    Parser.prototype.badProp = function badProp(token) {
        this.error('Unexpected separator in property', token[2], token[3]);
    };

    return Parser;
}();

exports.default = Parser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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T0FBTztBQUNmLGFBQUssS0FBTCxDQUFXLDBCQUFYLEVBQXVDLE1BQU0sQ0FBTixDQUF2QyxFQUFpRCxNQUFNLENBQU4sQ0FBakQsRUFEZTs7O0FBalNGLHFCQXFTakIsK0NBQWtCLE1BQU07QUFDcEIsYUFBSyxLQUFMLENBQVcsbUNBQVgsRUFBZ0QsS0FBSyxNQUFMLEVBQWEsQ0FBN0QsRUFEb0I7OztBQXJTUCxxQkF5U2pCLG1DQUFZLFVBQVUsTUFBTSxNQUFNO0FBQzlCLFlBQUksb0JBQW1CLGlDQUE4QixJQUFqRCxDQUQwQjtBQUU5QixhQUFLLEtBQUwsQ0FBVyxHQUFYLEVBQWdCLEtBQUssTUFBTCxFQUFhLENBQTdCLEVBRjhCOzs7QUF6U2pCLHFCQThTakIsMkJBQVEsT0FBTztBQUNYLGFBQUssS0FBTCxDQUFXLGtDQUFYLEVBQStDLE1BQU0sQ0FBTixDQUEvQyxFQUF5RCxNQUFNLENBQU4sQ0FBekQsRUFEVzs7O1dBOVNFIiwiZmlsZSI6InBhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEZWNsYXJhdGlvbiBmcm9tICdwb3N0Y3NzL2xpYi9kZWNsYXJhdGlvbic7XG5pbXBvcnQgQ29tbWVudCAgICAgZnJvbSAncG9zdGNzcy9saWIvY29tbWVudCc7XG5pbXBvcnQgQXRSdWxlICAgICAgZnJvbSAncG9zdGNzcy9saWIvYXQtcnVsZSc7XG5pbXBvcnQgUnVsZSAgICAgICAgZnJvbSAncG9zdGNzcy9saWIvcnVsZSc7XG5pbXBvcnQgUm9vdCAgICAgICAgZnJvbSAncG9zdGNzcy9saWIvcm9vdCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhcnNlciB7XG5cbiAgICBjb25zdHJ1Y3RvcihpbnB1dCkge1xuICAgICAgICB0aGlzLmlucHV0ID0gaW5wdXQ7XG5cbiAgICAgICAgdGhpcy5wb3MgICAgID0gMDtcbiAgICAgICAgdGhpcy5yb290ICAgID0gbmV3IFJvb3QoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5yb290O1xuICAgICAgICB0aGlzLnNwYWNlcyAgPSAnJztcblxuICAgICAgICB0aGlzLnByZXZJbmRlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuc3RlcCAgICAgICA9IHVuZGVmaW5lZDtcblxuICAgICAgICB0aGlzLnJvb3Quc291cmNlID0geyBpbnB1dCwgc3RhcnQ6IHsgbGluZTogMSwgY29sdW1uOiAxIH0gfTtcbiAgICB9XG5cbiAgICBsb29wKCkge1xuICAgICAgICBsZXQgcGFydDtcbiAgICAgICAgd2hpbGUgKCB0aGlzLnBvcyA8IHRoaXMucGFydHMubGVuZ3RoICkge1xuICAgICAgICAgICAgcGFydCA9IHRoaXMucGFydHNbdGhpcy5wb3NdO1xuXG4gICAgICAgICAgICBpZiAoIHBhcnQuY29tbWVudCApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1lbnQocGFydCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBwYXJ0LmF0cnVsZSApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmF0cnVsZShwYXJ0KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHBhcnQuY29sb24gKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5leHQgPSB0aGlzLm5leHROb25Db21tZW50KHRoaXMucG9zKTtcblxuICAgICAgICAgICAgICAgIGlmICggbmV4dC5lbmQgfHwgbmV4dC5hdHJ1bGUgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjbChwYXJ0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgc2FtZUluZGVudCA9IG5leHQuaW5kZW50Lmxlbmd0aCA9PT0gcGFydC5pbmRlbnQubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHNhbWVJbmRlbnQgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2wocGFydCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoICFzYW1lSW5kZW50ICYmIG5leHQuY29sb24gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJ1bGUocGFydCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoICFzYW1lSW5kZW50ICYmICFuZXh0LmNvbG9uICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNsKHBhcnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICggcGFydC5lbmQgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb290LnJhd3MuYWZ0ZXIgPSBwYXJ0LmJlZm9yZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ydWxlKHBhcnQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tbWVudChwYXJ0KSB7XG4gICAgICAgIGxldCB0b2tlbiA9IHBhcnQudG9rZW5zWzBdO1xuICAgICAgICBsZXQgbm9kZSAgPSBuZXcgQ29tbWVudCgpO1xuICAgICAgICB0aGlzLmluaXQobm9kZSwgcGFydCk7XG4gICAgICAgIG5vZGUuc291cmNlLmVuZCA9IHsgbGluZTogdG9rZW5bNF0sIGNvbHVtbjogdG9rZW5bNV0gfTtcblxuICAgICAgICBsZXQgdGV4dCA9IHRva2VuWzFdO1xuICAgICAgICBpZiAoIHRva2VuWzZdID09PSAnaW5saW5lJyApIHtcbiAgICAgICAgICAgIG5vZGUucmF3cy5pbmxpbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGV4dCA9IHRleHQuc2xpY2UoMik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0ZXh0ID0gdGV4dC5zbGljZSgyLCAtMik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbWF0Y2ggPSB0ZXh0Lm1hdGNoKC9eKFxccyopKFteXSpbXlxcc10pKFxccyopXFxuPyQvKTtcbiAgICAgICAgbm9kZS50ZXh0ID0gbWF0Y2hbMl07XG4gICAgICAgIG5vZGUucmF3cy5sZWZ0ID0gbWF0Y2hbMV07XG4gICAgICAgIG5vZGUucmF3cy5pbmxpbmVSaWdodCA9IG1hdGNoWzNdO1xuICAgIH1cblxuICAgIGF0cnVsZShwYXJ0KSB7XG4gICAgICAgIGxldCBhdHdvcmQgPSBwYXJ0LnRva2Vuc1swXTtcbiAgICAgICAgbGV0IHBhcmFtcyA9IHBhcnQudG9rZW5zLnNsaWNlKDEpO1xuXG4gICAgICAgIGxldCBub2RlICA9IG5ldyBBdFJ1bGUoKTtcbiAgICAgICAgbm9kZS5uYW1lID0gYXR3b3JkWzFdLnNsaWNlKDEpO1xuICAgICAgICB0aGlzLmluaXQobm9kZSwgcGFydCk7XG5cbiAgICAgICAgaWYgKCBub2RlLm5hbWUgPT09ICcnICkgdGhpcy51bm5hbWVkQXRydWxlKGF0d29yZCk7XG5cbiAgICAgICAgd2hpbGUgKCAhcGFydC5lbmQgJiYgcGFydC5sYXN0Q29tbWEgKSB7XG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICAgICAgcGFydCA9IHRoaXMucGFydHNbdGhpcy5wb3NdO1xuICAgICAgICAgICAgcGFyYW1zLnB1c2goWydzcGFjZScsIHBhcnQuYmVmb3JlICsgcGFydC5pbmRlbnRdKTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcy5jb25jYXQocGFydC50b2tlbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5yYXdzLmFmdGVyTmFtZSA9IHRoaXMuZmlyc3RTcGFjZXMocGFyYW1zKTtcbiAgICAgICAgdGhpcy5rZWVwVHJhaWxpbmdTcGFjZShub2RlLCBwYXJhbXMpO1xuICAgICAgICB0aGlzLnJhdyhub2RlLCAncGFyYW1zJywgcGFyYW1zLCBhdHdvcmQpO1xuICAgIH1cblxuICAgIGRlY2wocGFydCkge1xuICAgICAgICBsZXQgbm9kZSA9IG5ldyBEZWNsYXJhdGlvbigpO1xuICAgICAgICB0aGlzLmluaXQobm9kZSwgcGFydCk7XG5cbiAgICAgICAgbGV0IGJldHdlZW4gPSAnJztcbiAgICAgICAgbGV0IGNvbG9uICAgPSAwO1xuICAgICAgICBsZXQgdmFsdWUgICA9IFtdO1xuICAgICAgICBsZXQgcHJvcCAgICA9ICcnO1xuICAgICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBwYXJ0LnRva2Vucy5sZW5ndGg7IGkrKyApIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IHBhcnQudG9rZW5zW2ldO1xuICAgICAgICAgICAgaWYgKCB0b2tlblswXSA9PT0gJzonICkge1xuICAgICAgICAgICAgICAgIGJldHdlZW4gKz0gdG9rZW5bMV07XG4gICAgICAgICAgICAgICAgY29sb24gICAgPSB0b2tlbjtcbiAgICAgICAgICAgICAgICB2YWx1ZSAgICA9IHBhcnQudG9rZW5zLnNsaWNlKGkgKyAxKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHRva2VuWzBdID09PSAnY29tbWVudCcgfHwgdG9rZW5bMF0gPT09ICdzcGFjZScgKSB7XG4gICAgICAgICAgICAgICAgYmV0d2VlbiArPSB0b2tlblsxXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGJldHdlZW4gIT09ICcnICkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFkUHJvcCh0b2tlbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb3AgKz0gdG9rZW5bMV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIHByb3AgPT09ICcnICkgdGhpcy51bm5hbWVkRGVjbChwYXJ0LnRva2Vuc1swXSk7XG4gICAgICAgIG5vZGUucHJvcCA9IHByb3A7XG5cbiAgICAgICAgbGV0IG5leHQgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG5cbiAgICAgICAgd2hpbGUgKCAhbmV4dC5lbmQgJiYgIW5leHQuYXRydWxlICYmICFuZXh0LmNvbG9uICYmXG4gICAgICAgICAgICAgICAgbmV4dC5pbmRlbnQubGVuZ3RoID4gcGFydC5pbmRlbnQubGVuZ3RoICkge1xuICAgICAgICAgICAgdmFsdWUucHVzaChbJ3NwYWNlJywgbmV4dC5iZWZvcmUgKyBuZXh0LmluZGVudF0pO1xuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5jb25jYXQobmV4dC50b2tlbnMpO1xuICAgICAgICAgICAgdGhpcy5wb3MgKz0gMTtcbiAgICAgICAgICAgIG5leHQgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKCBsZXQgaSA9IHZhbHVlLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0gKSB7XG4gICAgICAgICAgICBsZXQgdCA9IHZhbHVlW2ldWzBdO1xuICAgICAgICAgICAgaWYgKCB0ID09PSAnd29yZCcgJiYgdmFsdWVbaV1bMV0gPT09ICchaW1wb3J0YW50JyApIHtcbiAgICAgICAgICAgICAgICBub2RlLmltcG9ydGFudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKCBpID4gMCAmJiB2YWx1ZVtpIC0gMV1bMF0gPT09ICdzcGFjZScgKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUucmF3cy5pbXBvcnRhbnQgPSB2YWx1ZVtpIC0gMV1bMV0gKyAnIWltcG9ydGFudCc7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlLnNwbGljZShpIC0gMSwgMik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5yYXdzLmltcG9ydGFudCA9ICchaW1wb3J0YW50JztcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHQgIT09ICdzcGFjZScgJiYgdCAhPT0gJ25ld2xpbmUnICYmIHQgIT09ICdjb21tZW50JyApIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGUucmF3cy5iZXR3ZWVuID0gYmV0d2VlbiArIHRoaXMuZmlyc3RTcGFjZXModmFsdWUpO1xuICAgICAgICB0aGlzLnJhdyhub2RlLCAndmFsdWUnLCB2YWx1ZSwgY29sb24pO1xuICAgIH1cblxuICAgIHJ1bGUocGFydCkge1xuICAgICAgICBsZXQgbm9kZSA9IG5ldyBSdWxlKCk7XG4gICAgICAgIHRoaXMuaW5pdChub2RlLCBwYXJ0KTtcblxuICAgICAgICBsZXQgc2VsZWN0b3IgPSBwYXJ0LnRva2VucztcbiAgICAgICAgbGV0IG5leHQgICAgID0gdGhpcy5wYXJ0c1t0aGlzLnBvcyArIDFdO1xuXG4gICAgICAgIHdoaWxlICggIW5leHQuZW5kICYmIG5leHQuaW5kZW50Lmxlbmd0aCA9PT0gcGFydC5pbmRlbnQubGVuZ3RoICkge1xuICAgICAgICAgICAgc2VsZWN0b3IucHVzaChbJ3NwYWNlJywgbmV4dC5iZWZvcmUgKyBuZXh0LmluZGVudF0pO1xuICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5jb25jYXQobmV4dC50b2tlbnMpO1xuICAgICAgICAgICAgdGhpcy5wb3MgKz0gMTtcbiAgICAgICAgICAgIG5leHQgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmtlZXBUcmFpbGluZ1NwYWNlKG5vZGUsIHNlbGVjdG9yKTtcbiAgICAgICAgdGhpcy5yYXcobm9kZSwgJ3NlbGVjdG9yJywgc2VsZWN0b3IpO1xuICAgIH1cblxuICAgIC8qIEhlbHBlcnMgKi9cblxuICAgIGluZGVudChwYXJ0KSB7XG4gICAgICAgIGxldCBpbmRlbnQgPSBwYXJ0LmluZGVudC5sZW5ndGg7XG4gICAgICAgIGxldCBpc1ByZXYgPSB0eXBlb2YgdGhpcy5wcmV2SW5kZW50ICE9PSAndW5kZWZpbmVkJztcblxuICAgICAgICBpZiAoICFpc1ByZXYgJiYgaW5kZW50ICkgdGhpcy5pbmRlbnRlZEZpcnN0TGluZShwYXJ0KTtcblxuICAgICAgICBpZiAoICF0aGlzLnN0ZXAgJiYgaW5kZW50ICkge1xuICAgICAgICAgICAgdGhpcy5zdGVwID0gaW5kZW50O1xuICAgICAgICAgICAgdGhpcy5yb290LnJhd3MuaW5kZW50ID0gcGFydC5pbmRlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIGlzUHJldiAmJiB0aGlzLnByZXZJbmRlbnQgIT09IGluZGVudCApIHtcbiAgICAgICAgICAgIGxldCBkaWZmID0gaW5kZW50IC0gdGhpcy5wcmV2SW5kZW50O1xuICAgICAgICAgICAgaWYgKCBkaWZmID4gMCApIHtcbiAgICAgICAgICAgICAgICBpZiAoIGRpZmYgIT09IHRoaXMuc3RlcCApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53cm9uZ0luZGVudCh0aGlzLnByZXZJbmRlbnQgKyB0aGlzLnN0ZXAsIGluZGVudCwgcGFydCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5jdXJyZW50Lmxhc3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICggZGlmZiAlIHRoaXMuc3RlcCAhPT0gMCApIHtcbiAgICAgICAgICAgICAgICBsZXQgbSA9IGluZGVudCArIGRpZmYgJSB0aGlzLnN0ZXA7XG4gICAgICAgICAgICAgICAgdGhpcy53cm9uZ0luZGVudChgJHsgbSB9IG9yICR7IG0gKyB0aGlzLnN0ZXAgfWAsIGluZGVudCwgcGFydCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IC1kaWZmIC8gdGhpcy5zdGVwOyBpKysgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMuY3VycmVudC5wYXJlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wcmV2SW5kZW50ID0gaW5kZW50O1xuICAgIH1cblxuICAgIGluaXQobm9kZSwgcGFydCkge1xuICAgICAgICB0aGlzLmluZGVudChwYXJ0KTtcblxuICAgICAgICBpZiAoICF0aGlzLmN1cnJlbnQubm9kZXMgKSB0aGlzLmN1cnJlbnQubm9kZXMgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50LnB1c2gobm9kZSk7XG5cbiAgICAgICAgbm9kZS5yYXdzLmJlZm9yZSA9IHBhcnQuYmVmb3JlICsgcGFydC5pbmRlbnQ7XG4gICAgICAgIG5vZGUuc291cmNlID0ge1xuICAgICAgICAgICAgc3RhcnQ6IHsgbGluZTogcGFydC50b2tlbnNbMF1bMl0sIGNvbHVtbjogcGFydC50b2tlbnNbMF1bM10gfSxcbiAgICAgICAgICAgIGlucHV0OiB0aGlzLmlucHV0XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAga2VlcFRyYWlsaW5nU3BhY2Uobm9kZSwgdG9rZW5zKSB7XG4gICAgICAgIGxldCBsYXN0U3BhY2UgPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAoIGxhc3RTcGFjZSAmJiBsYXN0U3BhY2VbMF0gPT09ICdzcGFjZScgKSB7XG4gICAgICAgICAgICB0b2tlbnMucG9wKCk7XG4gICAgICAgICAgICBub2RlLnJhd3Muc3NzQmV0d2VlbiA9IGxhc3RTcGFjZVsxXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZpcnN0U3BhY2VzKHRva2Vucykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gJyc7XG4gICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKyApIHtcbiAgICAgICAgICAgIGlmICggdG9rZW5zW2ldWzBdID09PSAnc3BhY2UnIHx8IHRva2Vuc1tpXVswXSA9PT0gJ25ld2xpbmUnICkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCArPSB0b2tlbnMuc2hpZnQoKVsxXTtcbiAgICAgICAgICAgICAgICBpIC09IDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcmF3KG5vZGUsIHByb3AsIHRva2VucywgYWx0TGFzdCkge1xuICAgICAgICBsZXQgdG9rZW4sIHR5cGU7XG4gICAgICAgIGxldCBsZW5ndGggPSB0b2tlbnMubGVuZ3RoO1xuICAgICAgICBsZXQgdmFsdWUgID0gJyc7XG4gICAgICAgIGxldCBjbGVhbiAgPSB0cnVlO1xuICAgICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSApIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5zW2ldO1xuICAgICAgICAgICAgdHlwZSAgPSB0b2tlblswXTtcbiAgICAgICAgICAgIGlmICggdHlwZSA9PT0gJ2NvbW1lbnQnIHx8IHR5cGUgPT09ICdzcGFjZScgJiYgaSA9PT0gbGVuZ3RoIC0gMSApIHtcbiAgICAgICAgICAgICAgICBjbGVhbiA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSArPSB0b2tlblsxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoICFjbGVhbiApIHtcbiAgICAgICAgICAgIGxldCBzc3MgPSB0b2tlbnMucmVkdWNlKCAoYWxsLCBpKSA9PiBhbGwgKyBpWzFdLCAnJyk7XG4gICAgICAgICAgICBsZXQgcmF3ID0gdG9rZW5zLnJlZHVjZSggKGFsbCwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICggaVswXSA9PT0gJ2NvbW1lbnQnICYmIGlbNl0gPT09ICdpbmxpbmUnICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsICsgJy8qICcgKyBpWzFdLnNsaWNlKDIpLnRyaW0oKSArICcgKi8nO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGwgKyBpWzFdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sICcnKTtcbiAgICAgICAgICAgIG5vZGUucmF3c1twcm9wXSA9IHsgdmFsdWUsIHJhdyB9O1xuICAgICAgICAgICAgaWYgKCBzc3MgIT09IHJhdyApIG5vZGUucmF3c1twcm9wXS5zc3MgPSBzc3M7XG4gICAgICAgIH1cbiAgICAgICAgbm9kZVtwcm9wXSA9IHZhbHVlO1xuXG4gICAgICAgIGxldCBsYXN0ID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXSB8fCBhbHRMYXN0O1xuICAgICAgICBub2RlLnNvdXJjZS5lbmQgPSB7IGxpbmU6IGxhc3RbNF0sIGNvbHVtbjogbGFzdFs1XSB9O1xuICAgIH1cblxuICAgIG5leHROb25Db21tZW50KHBvcykge1xuICAgICAgICBsZXQgbmV4dCA9IHBvcztcbiAgICAgICAgbGV0IHBhcnQ7XG4gICAgICAgIHdoaWxlICggbmV4dCA8IHRoaXMucGFydHMubGVuZ3RoICkge1xuICAgICAgICAgICAgbmV4dCArPSAxO1xuICAgICAgICAgICAgcGFydCA9IHRoaXMucGFydHNbbmV4dF07XG4gICAgICAgICAgICBpZiAoIHBhcnQuZW5kIHx8ICFwYXJ0LmNvbW1lbnQgKSBicmVhaztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGFydDtcbiAgICB9XG5cbiAgICAvLyBFcnJvcnNcblxuICAgIGVycm9yKG1zZywgbGluZSwgY29sdW1uKSB7XG4gICAgICAgIHRocm93IHRoaXMuaW5wdXQuZXJyb3IobXNnLCBsaW5lLCBjb2x1bW4pO1xuICAgIH1cblxuICAgIHVubmFtZWRBdHJ1bGUodG9rZW4pIHtcbiAgICAgICAgdGhpcy5lcnJvcignQXQtcnVsZSB3aXRob3V0IG5hbWUnLCB0b2tlblsyXSwgdG9rZW5bM10pO1xuICAgIH1cblxuICAgIHVubmFtZWREZWNsKHRva2VuKSB7XG4gICAgICAgIHRoaXMuZXJyb3IoJ0RlY2xhcmF0aW9uIHdpdGhvdXQgbmFtZScsIHRva2VuWzJdLCB0b2tlblszXSk7XG4gICAgfVxuXG4gICAgaW5kZW50ZWRGaXJzdExpbmUocGFydCkge1xuICAgICAgICB0aGlzLmVycm9yKCdGaXJzdCBsaW5lIHNob3VsZCBub3QgaGF2ZSBpbmRlbnQnLCBwYXJ0Lm51bWJlciwgMSk7XG4gICAgfVxuXG4gICAgd3JvbmdJbmRlbnQoZXhwZWN0ZWQsIHJlYWwsIHBhcnQpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBFeHBlY3RlZCAkeyBleHBlY3RlZCB9IGluZGVudCwgYnV0IGdldCAkeyByZWFsIH1gO1xuICAgICAgICB0aGlzLmVycm9yKG1zZywgcGFydC5udW1iZXIsIDEpO1xuICAgIH1cblxuICAgIGJhZFByb3AodG9rZW4pIHtcbiAgICAgICAgdGhpcy5lcnJvcignVW5leHBlY3RlZCBzZXBhcmF0b3IgaW4gcHJvcGVydHknLCB0b2tlblsyXSwgdG9rZW5bM10pO1xuICAgIH1cblxufVxuIl19